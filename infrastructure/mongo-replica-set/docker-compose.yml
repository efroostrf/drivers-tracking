services:
  mongo-1:
    image: mongo:8.0
    container_name: mongo-1
    restart: unless-stopped
    ports:
      - 27017:27017
    command: ["--replSet", "rs0", "--keyFile", "/data/keyfile", "--bind_ip_all"]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./mongo/node1/data:/data/db
      - ./mongo/node1/configdb:/data/configdb
      - ./mongo/keyfile:/data/keyfile:ro

  mongo-2:
    image: mongo:8.0
    container_name: mongo-2
    restart: unless-stopped
    ports:
      - 27018:27017
    command: ["--replSet", "rs0", "--keyFile", "/data/keyfile", "--bind_ip_all"]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./mongo/node2/data:/data/db
      - ./mongo/node2/configdb:/data/configdb
      - ./mongo/keyfile:/data/keyfile:ro

  mongo-3:
    image: mongo:8.0
    container_name: mongo-3
    restart: unless-stopped
    ports:
      - 27019:27017
    command: ["--replSet", "rs0", "--keyFile", "/data/keyfile", "--bind_ip_all"]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./mongo/node3/data:/data/db
      - ./mongo/node3/configdb:/data/configdb
      - ./mongo/keyfile:/data/keyfile:ro

  mongo-exporter-1:
    image: percona/mongodb_exporter:0.47.2
    container_name: mongo-exporter-1
    restart: unless-stopped
    ports:
      - 9216:9216
    command:
      - '--mongodb.uri=mongodb://prometheus:${MONGO_PROMETHEUS_PASSWORD}@mongo-1:27017/?authSource=admin'
      - '--collect-all'
    depends_on:
      mongo-1:
        condition: service_healthy

  mongo-exporter-2:
    image: percona/mongodb_exporter:0.47.2
    container_name: mongo-exporter-2
    restart: unless-stopped
    ports:
      - 9217:9216
    command:
      - '--mongodb.uri=mongodb://prometheus:${MONGO_PROMETHEUS_PASSWORD}@mongo-2:27017/?authSource=admin'
      - '--collect-all'
    depends_on:
      mongo-2:
        condition: service_healthy

  mongo-exporter-3:
    image: percona/mongodb_exporter:0.47.2
    container_name: mongo-exporter-3
    restart: unless-stopped
    ports:
      - 9218:9216
    command:
      - '--mongodb.uri=mongodb://prometheus:${MONGO_PROMETHEUS_PASSWORD}@mongo-3:27017/?authSource=admin'
      - '--collect-all'
    depends_on:
      mongo-3:
        condition: service_healthy
